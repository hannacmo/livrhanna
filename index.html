<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>livrhanna</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #F4F0E4;
    --teal:      #44A194;
    --teal-dark: #358078;
    --teal-pale: #d4efec;
    --blue:      #537D96;
    --blue-dark: #3f617a;
    --blue-pale: #d6e5ef;
    --pink:      #EC8F8D;
    --pink-dark: #d4706e;
    --pink-pale: #fce8e8;
    --ink:       #2a2a2a;
    --mid:       #6b6b6b;
    --light:     #e8e4d8;
    --white:     #ffffff;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--ink);
    min-height: 100vh; font-size: 15px;
    text-transform: lowercase;
  }

  .book-title, .pub-title, .book-author, .pub-author,
  .modal-book-title, .modal-book-author, .res-name { text-transform: none !important; }
  input, textarea, select { text-transform: none; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  #loading-screen {
    position: fixed; inset: 0; background: var(--teal);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    z-index: 999; transition: opacity .4s;
  }
  #loading-screen.hidden { opacity: 0; pointer-events: none; }
  .loading-logo { font-family: 'Playfair Display', serif; font-size: 3rem; color: white; font-style: italic; margin-bottom: 20px; }
  .spinner { width: 36px; height: 36px; border: 3px solid rgba(255,255,255,.3); border-top-color: white; border-radius: 50%; animation: spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HERO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .hero { background: var(--teal); padding: 48px 36px 30px; text-align: center; }
  .logo { font-family: 'Playfair Display', serif; font-size: 2.8rem; color: var(--white); font-style: italic; display: block; margin-bottom: 10px; text-transform: lowercase; }
  .hero p { font-size: .97rem; color: rgba(255,255,255,.75); max-width: 500px; margin: 0 auto 22px; line-height: 1.65; }

  .hero-search { max-width: 400px; margin: 0 auto 16px; position: relative; }
  .hero-search input {
    width: 100%; padding: 11px 18px 11px 40px;
    border: 2px solid rgba(255,255,255,.22); border-radius: 24px;
    background: rgba(255,255,255,.14); color: white;
    font-family: 'DM Sans', sans-serif; font-size: .93rem; transition: all .2s; text-transform: none;
  }
  .hero-search input::placeholder { color: rgba(255,255,255,.48); }
  .hero-search input:focus { outline: none; background: rgba(255,255,255,.22); border-color: rgba(255,255,255,.6); }
  .hero-search::before { content: 'üîç'; position: absolute; left: 13px; top: 50%; transform: translateY(-50%); }

  /* ‚îÄ‚îÄ FILTER ROW ‚îÄ‚îÄ */
  .filter-row {
    display: flex; justify-content: center; align-items: center;
    gap: 6px; flex-wrap: wrap; margin-bottom: 16px;
    max-width: 780px; margin-left: auto; margin-right: auto;
  }

  .filter-chip {
    padding: 5px 13px; border: 1.5px solid rgba(255,255,255,.28);
    border-radius: 20px; background: transparent;
    color: rgba(255,255,255,.72); font-family: 'DM Sans', sans-serif;
    font-size: .75rem; font-weight: 500; cursor: pointer; transition: all .2s;
    white-space: nowrap;
  }
  .filter-chip:hover { background: rgba(255,255,255,.14); color: white; }
  .filter-chip.active { background: white; color: var(--teal); font-weight: 700; border-color: white; }

  .filter-select {
    padding: 5px 13px; border: 1.5px solid rgba(255,255,255,.28);
    border-radius: 20px; background: transparent;
    color: rgba(255,255,255,.72); font-family: 'DM Sans', sans-serif;
    font-size: .75rem; cursor: pointer; transition: all .2s;
    appearance: none; text-transform: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='rgba(255,255,255,.6)'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    padding-right: 28px;
  }
  .filter-select:focus { outline: none; }
  .filter-select option { background: var(--teal-dark); color: white; }
  .filter-select.active { background-color: white; color: var(--teal); font-weight: 700; border-color: white; }

  .hero-stats { display: flex; justify-content: center; gap: 28px; margin-top: 4px; }
  .hstat { font-size: .75rem; color: rgba(255,255,255,.68); }
  .hstat strong { font-family: 'Playfair Display', serif; font-size: 1.25rem; color: var(--white); display: block; line-height: 1.2; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADMIN BAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .admin-bar { display: none; background: var(--ink); padding: 8px 28px; align-items: center; justify-content: space-between; gap: 10px; }
  .admin-bar.on { display: flex; }
  .admin-bar span { font-size: .76rem; color: rgba(255,255,255,.6); }
  .admin-bar span em { color: var(--teal); font-style: normal; }
  .btn-exit-admin { padding: 5px 14px; background: transparent; border: 1px solid rgba(255,255,255,.2); border-radius: 20px; font-size: .74rem; color: rgba(255,255,255,.5); cursor: pointer; transition: all .2s; font-family: 'DM Sans', sans-serif; }
  .btn-exit-admin:hover { border-color: rgba(255,255,255,.5); color: white; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTAINER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .container { max-width: 1100px; margin: 0 auto; padding: 28px 28px; }

  .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; flex-wrap: wrap; }
  .section-label { font-size: .7rem; color: var(--mid); letter-spacing: .1em; }

  .sort-select {
    padding: 5px 30px 5px 11px; border: 1.5px solid var(--light); border-radius: 20px;
    background: var(--white); font-family: 'DM Sans', sans-serif;
    font-size: .75rem; color: var(--mid); cursor: pointer;
    appearance: none; transition: all .2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236b6b6b'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
    background-color: var(--white);
  }
  .sort-select:focus { outline: none; border-color: var(--teal); }

  .btn-add {
    padding: 9px 20px; background: var(--teal); border: none;
    border-radius: 20px; font-family: 'DM Sans', sans-serif;
    font-size: .82rem; font-weight: 700; color: white;
    cursor: pointer; transition: background .2s;
  }
  .btn-add:hover { background: var(--teal-dark); }

  .btn-restricted {
    padding: 9px 18px; background: transparent;
    border: 1.5px solid var(--light); border-radius: 20px;
    font-family: 'DM Sans', sans-serif; font-size: .78rem;
    font-weight: 500; color: var(--mid); cursor: pointer; transition: all .2s;
  }
  .btn-restricted:hover { border-color: var(--teal); color: var(--teal); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOOK GRID ‚Äî vertical book proportions ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .books-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 18px;
  }

  .book-card {
    background: var(--white); border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,.07);
    overflow: hidden; transition: transform .22s, box-shadow .22s;
    animation: fadeUp .3s ease both;
    display: flex; flex-direction: column;
    border: 1.5px solid var(--light); position: relative;
  }

  @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

  .book-card:hover { transform: translateY(-5px); box-shadow: 0 10px 26px rgba(0,0,0,.12); }
  .book-card.is-reserved { border-color: rgba(68,161,148,.35); }

  /* admin edit/delete ‚Äî only when admin unlocked */
  .card-admin { position: absolute; top: 6px; right: 6px; display: none; gap: 4px; z-index: 10; }
  body.admin-unlocked .card-admin { display: flex; }

  .card-btn {
    width: 26px; height: 26px; border-radius: 50%; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: .72rem; transition: all .15s; box-shadow: 0 1px 4px rgba(0,0,0,.2);
  }
  .card-btn.edit { background: white; color: var(--blue); }
  .card-btn.del  { background: white; color: var(--pink-dark); }
  .card-btn.edit:hover { background: var(--blue);     color: white; }
  .card-btn.del:hover  { background: var(--pink-dark); color: white; }

  /* cover ‚Äî 2:3 book proportion */
  .book-cover {
    width: 100%;
    aspect-ratio: 2 / 3;
    overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    font-size: 3.5rem; background: var(--light);
    position: relative; flex-shrink: 0;
  }

  .book-cover img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; }
  .cover-emoji { position: relative; z-index: 1; }

  .donate-badge {
    position: absolute; top: 7px; left: 7px; z-index: 4;
    font-size: .56rem; padding: 2px 7px; border-radius: 10px;
    background: var(--teal); color: white; font-weight: 700;
  }

  .reserved-overlay {
    position: absolute; inset: 0; background: rgba(83,125,150,.4);
    display: flex; align-items: center; justify-content: center; z-index: 3;
  }
  .reserved-stamp {
    border: 2px solid white; color: white;
    font-family: 'Playfair Display', serif; font-size: .8rem; font-weight: 700;
    padding: 3px 12px; letter-spacing: .1em; transform: rotate(-12deg);
  }

  /* book info below cover */
  .book-body { padding: 10px 11px 4px; flex: 1; }
  .pub-title  { font-family: 'Playfair Display', serif; font-size: .9rem; font-weight: 700; line-height: 1.3; margin-bottom: 2px; color: var(--ink); }
  .pub-author { font-size: .72rem; color: var(--mid); font-style: italic; margin-bottom: 6px; }

  .book-meta { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 6px; }
  .meta-tag { font-size: .57rem; padding: 2px 6px; border-radius: 10px; background: var(--light); color: var(--mid); font-weight: 500; }

  .book-rating { color: var(--pink); font-size: .72rem; margin-bottom: 5px; }

  .reserved-by {
    display: flex; align-items: center; gap: 6px;
    background: var(--teal-pale); border-radius: 6px;
    padding: 6px 8px; margin-bottom: 7px;
    font-size: .74rem; color: var(--teal-dark);
  }
  .avatar {
    width: 24px; height: 24px; border-radius: 50%;
    background: var(--teal); color: white;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif; font-weight: 700;
    font-size: .72rem; flex-shrink: 0; text-transform: uppercase;
  }
  .res-label { font-size: .62rem; color: var(--teal); display: block; opacity: .75; }

  .book-footer { padding: 0 11px 12px; margin-top: auto; padding-top: 3px; }
  .btn-quero {
    width: 100%; padding: 8px; background: var(--teal); border: none;
    border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: .82rem;
    font-weight: 700; color: white; cursor: pointer; transition: background .2s;
  }
  .btn-quero:hover { background: var(--teal-dark); }

  /* cancel reserve ‚Äî only shown to admin */
  .btn-cancelar {
    display: none; /* hidden by default */
    width: 100%; padding: 6px; background: transparent;
    border: 1.5px solid var(--light); border-radius: 8px;
    font-size: .68rem; color: var(--mid); cursor: pointer;
    transition: all .15s; margin-top: 4px; font-family: 'DM Sans', sans-serif;
  }
  body.admin-unlocked .btn-cancelar { display: block; }
  .btn-cancelar:hover { border-color: var(--pink); color: var(--pink-dark); }

  .book-notes { font-size: .68rem; color: var(--mid); font-style: italic; padding: 0 11px 9px; line-height: 1.4; }

  .clickable-tag {
    cursor: pointer; transition: all .15s;
  }
  .clickable-tag:hover {
    background: var(--teal) !important;
    color: white !important;
  }
  .pub-author.clickable-tag:hover { color: var(--teal) !important; background: none !important; text-decoration: underline; }

  .btn-amazon {
    display: flex; align-items: center; justify-content: center; gap: 5px;
    width: 100%; padding: 7px 10px; margin-top: 5px;
    background: #FF9900; border: none; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 700;
    color: #111; cursor: pointer; text-decoration: none;
    transition: background .2s; line-height: 1;
  }
  .btn-amazon:hover { background: #e68a00; }
  .btn-amazon svg { flex-shrink: 0; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPTY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .empty-state { text-align: center; padding: 70px 20px; color: var(--mid); }
  .empty-state .icon { font-size: 3.5rem; margin-bottom: 14px; }
  .empty-state h3 { font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 7px; color: var(--ink); }
  .empty-state p  { font-size: .87rem; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(42,42,42,.55); z-index: 200;
    align-items: center; justify-content: center;
    padding: 20px; backdrop-filter: blur(4px);
  }
  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--bg); border-radius: 14px;
    width: 100%; max-width: 500px; max-height: 92vh;
    overflow-y: auto; box-shadow: 0 24px 60px rgba(0,0,0,.18);
    animation: slideUp .26s cubic-bezier(.22,1,.36,1);
  }
  @keyframes slideUp { from { opacity:0; transform:translateY(24px) scale(.97); } to { opacity:1; transform:translateY(0) scale(1); } }

  .modal-header { padding: 20px 22px 14px; border-bottom: 1px solid var(--light); display: flex; justify-content: space-between; align-items: flex-start; }
  .modal-header h2 { font-family: 'Playfair Display', serif; font-size: 1.25rem; color: var(--ink); }
  .modal-header p  { font-size: .77rem; color: var(--mid); margin-top: 2px; }
  .modal-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--mid); }

  .modal-book-preview { display: flex; align-items: center; gap: 12px; padding: 12px 22px; background: var(--light); border-bottom: 1px solid rgba(0,0,0,.05); }
  .modal-book-icon { width: 52px; height: 52px; border-radius: 6px; overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
  .modal-book-icon img { width:100%; height:100%; object-fit:cover; }
  .modal-book-title  { font-family:'Playfair Display',serif; font-size:.93rem; font-weight:700; color:var(--ink); }
  .modal-book-author { font-size:.76rem; color:var(--mid); font-style:italic; }

  .modal-body { padding: 18px 22px; }

  .form-group { margin-bottom: 13px; }
  .form-group label { display: block; font-size: .71rem; color: var(--mid); margin-bottom: 5px; font-weight: 700; letter-spacing: .04em; }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 9px 11px; border: 1.5px solid var(--light); border-radius: 8px;
    background: var(--white); font-family: 'DM Sans', sans-serif; font-size: .87rem;
    color: var(--ink); transition: border-color .2s; text-transform: none;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--teal); }

  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

  /* combo field: datalist input */
  .combo-wrap { position: relative; }
  .combo-wrap input { width: 100%; }

  .checkbox-group { display: flex; gap: 14px; flex-wrap: wrap; }
  .checkbox-label { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: .8rem; color: var(--mid); }

  /* cover upload */
  .cover-upload-area {
    border: 2px dashed var(--light); border-radius: 8px; padding: 14px;
    text-align: center; cursor: pointer; transition: all .2s; position: relative;
    overflow: hidden; display: flex; flex-direction: column; align-items: center;
    justify-content: center; gap: 4px; min-height: 72px;
  }
  .cover-upload-area:hover { border-color: var(--teal); background: var(--teal-pale); }
  .cover-upload-area input { position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%; }
  .cover-upload-area .upload-icon { font-size: 1.6rem; }
  .cover-upload-area p { font-size: .75rem; color: var(--mid); }
  .cover-upload-area img.preview { width:100%; max-height:130px; object-fit:cover; border-radius:6px; }

  .modal-footer { padding: 4px 22px 20px; }
  .btn-save { width: 100%; padding: 11px; background: var(--teal); border: none; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: .95rem; font-weight: 700; color: white; cursor: pointer; transition: background .2s; }
  .btn-save:hover { background: var(--teal-dark); }
  .btn-save:disabled { opacity: .6; cursor: wait; }

  .btn-cancel-sm { width: 100%; padding: 8px; margin-top: 7px; background: transparent; border: 1.5px solid var(--light); border-radius: 8px; font-family: 'DM Sans', sans-serif; color: var(--mid); cursor: pointer; font-size: .82rem; transition: all .2s; }
  .btn-cancel-sm:hover { border-color: var(--mid); }

  .privacy-note { text-align: center; font-size: .7rem; color: var(--mid); margin-top: 8px; font-style: italic; }

  /* password modal */
  .pass-body { padding: 30px 26px 24px; text-align: center; }
  .pass-body .lock-icon { font-size: 2.5rem; margin-bottom: 10px; }
  .pass-body h2 { font-family:'Playfair Display',serif; font-size:1.25rem; margin-bottom:6px; color:var(--ink); }
  .pass-body p  { font-size:.82rem; color:var(--mid); margin-bottom:18px; }
  .pass-input-wrap { position: relative; margin-bottom: 12px; }
  .pass-input-wrap input { font-size: 1rem; letter-spacing: .12em; text-align: center; padding-right: 38px; }
  .pass-eye { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: .95rem; color: var(--mid); }
  .pass-error { font-size: .78rem; color: var(--pink-dark); margin-bottom: 10px; min-height: 18px; }

  /* success */
  .success-body { padding: 28px 22px 24px; text-align: center; }
  .success-icon { font-size: 3.2rem; margin-bottom: 12px; }
  .success-body h3 { font-family:'Playfair Display',serif; font-size:1.3rem; color:var(--teal); margin-bottom:8px; }
  .success-body p  { font-size:.86rem; color:var(--mid); line-height:1.6; }
  .btn-fechar { margin-top: 18px; padding: 10px 28px; background: var(--teal); border: none; border-radius: 8px; color: white; font-family: 'DM Sans', sans-serif; font-size: .9rem; font-weight: 700; cursor: pointer; transition: background .2s; }
  .btn-fechar:hover { background: var(--teal-dark); }

  /* toast */
  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--ink); color: white; padding: 10px 18px; border-radius: 8px; font-size: .86rem; transform: translateY(70px); opacity: 0; transition: all .3s; z-index: 300; border-left: 3px solid var(--teal); max-width: 280px; }
  .toast.show { transform: translateY(0); opacity: 1; }

  /* config warning */
  .config-warning { background: var(--pink-pale); border: 2px solid var(--pink); border-radius: 10px; padding: 20px 24px; margin-bottom: 24px; text-align: center; }
  .config-warning h3 { font-family:'Playfair Display',serif; color:var(--pink-dark); margin-bottom:8px; font-size:1.1rem; }
  .config-warning p  { font-size:.85rem; color:var(--ink); line-height:1.6; }
  .config-warning code { background: rgba(236,143,141,.2); padding: 2px 6px; border-radius:4px; font-family:monospace; font-size:.82rem; }

  @media (max-width: 640px) {
    .hero { padding: 36px 18px 26px; }
    .container { padding: 20px 14px; }
    .books-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div id="loading-screen">
  <div class="loading-logo">livrhanna</div>
  <div class="spinner"></div>
</div>

<!-- HERO -->
<div class="hero">
  <span class="logo">livrhanna</span>
  <p>os livros da minha estante ‚Äî os marcados com üíö est√£o dispon√≠veis para doa√ß√£o. clique em <strong style="color:white;">"eu quero!"</strong> para reservar.</p>
  <div class="hero-search">
    <input type="text" id="search" placeholder="buscar por t√≠tulo, autor ou editora..." oninput="render()">
  </div>

  <!-- FILTER CHIPS -->
  <div class="filter-row" id="filter-row">
    <button class="filter-chip active" data-filter="all" onclick="setFilter('all',this)">todos</button>
    <button class="filter-chip" data-filter="donate" onclick="setFilter('donate',this)">üíö para doa√ß√£o</button>
    <button class="filter-chip admin-only-filter" data-filter="read" onclick="setFilter('read',this)" style="display:none;">‚úÖ lidos</button>
    <button class="filter-chip admin-only-filter" data-filter="wishlist" onclick="setFilter('wishlist',this)" style="display:none;">üîµ wishlist</button>
    <select class="filter-select" id="filter-rating" onchange="setFilter('rating',this)">
      <option value="">por avalia√ß√£o...</option>
    </select>
    <select class="filter-select" id="filter-author" onchange="setFilter('author',this)">
      <option value="">por autor...</option>
    </select>
    <select class="filter-select" id="filter-publisher" onchange="setFilter('publisher',this)">
      <option value="">por editora...</option>
    </select>
    <select class="filter-select" id="filter-genre" onchange="setFilter('genre',this)">
      <option value="">por g√™nero...</option>
    </select>
  </div>

  <div class="hero-stats">
    <div class="hstat"><strong id="stat-total">0</strong>na estante</div>
    <div class="hstat"><strong id="stat-donate">0</strong>para doa√ß√£o</div>
    <div class="hstat"><strong id="stat-reserved">0</strong>reservados</div>
  </div>
</div>

<!-- ADMIN BAR -->
<div class="admin-bar" id="admin-bar">
  <span>‚úèÔ∏è modo admin <em>ativado</em> ‚Äî somente voc√™ est√° vendo isso</span>
  <button class="btn-exit-admin" onclick="exitAdmin()">sair</button>
</div>

<!-- CONTENT -->
<div class="container">
  <div class="toolbar">
    <div class="section-label" id="section-label">carregando...</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <select class="sort-select" id="sort-select" onchange="render()">
        <option value="added-desc">mais recentes primeiro</option>
        <option value="added-asc">mais antigos primeiro</option>
        <option value="alpha-asc">a ‚Üí z</option>
        <option value="alpha-desc">z ‚Üí a</option>
      </select>
      <button class="btn-add" id="btn-add-book" onclick="openBookModal()" style="display:none;">Ôºã adicionar livro</button>
      <button class="btn-restricted" onclick="clickAdd()" id="btn-restricted">üîê √°rea restrita</button>
    </div>
  </div>
  <div id="config-warning-area"></div>
  <div class="books-grid" id="books-grid"></div>
  <div class="empty-state" id="empty-state" style="display:none;">
    <div class="icon">üìö</div>
    <h3>nenhum livro encontrado</h3>
    <p>tente buscar por outro t√≠tulo ou ajuste o filtro.</p>
  </div>
</div>

<!-- MODAL: SENHA -->
<div class="modal-overlay" id="pass-modal">
  <div class="modal" style="max-width:360px;">
    <div class="pass-body">
      <div class="lock-icon">üîê</div>
      <h2>√°rea restrita</h2>
      <p>apenas hanna pode adicionar livros.<br>digite a senha para continuar.</p>
      <div class="pass-input-wrap">
        <input type="password" id="pass-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')checkPass()">
        <button class="pass-eye" onclick="togglePassVis()">üëÅ</button>
      </div>
      <p class="pass-error" id="pass-error"></p>
      <button class="btn-save" onclick="checkPass()">entrar</button>
      <button class="btn-cancel-sm" onclick="closePassModal()">cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL: ADICIONAR / EDITAR -->
<div class="modal-overlay" id="book-modal">
  <div class="modal">
    <div class="modal-header">
      <h2 id="book-modal-title">novo livro</h2>
      <button class="modal-close" onclick="closeBookModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>foto da capa</label>
        <div class="cover-upload-area" id="cover-area">
          <input type="file" accept="image/*" onchange="handleCover(event)">
          <div id="cover-content">
            <div class="upload-icon">üì∑</div>
            <p>clique para adicionar uma foto</p>
          </div>
        </div>
      </div>
      <div class="form-group"><label>t√≠tulo *</label><input type="text" id="f-title" placeholder="ex: o alquimista"></div>
      <div class="form-row">
        <div class="form-group">
          <label>autor *</label>
          <div class="combo-wrap">
            <input type="text" id="f-author" list="authors-list" placeholder="ex: paulo coelho" autocomplete="off">
            <datalist id="authors-list"></datalist>
          </div>
        </div>
        <div class="form-group">
          <label>editora</label>
          <div class="combo-wrap">
            <input type="text" id="f-publisher" list="publishers-list" placeholder="ex: companhia das letras" autocomplete="off">
            <datalist id="publishers-list"></datalist>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>quantidade de unidades</label>
          <input type="number" id="f-qty" placeholder="1" min="1" max="99" value="1" oninput="handleQtyChange()">
        </div>
        <div class="form-group" style="display:flex;align-items:flex-end;">
          <p style="font-size:.72rem;color:var(--mid);line-height:1.5;padding-bottom:10px;">acima de 1 unidade ‚Üí marcado automaticamente como <strong>repetido</strong> e <strong>para doa√ß√£o</strong></p>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>g√™nero</label>
          <select id="f-genre">
            <option value="">selecionar...</option>
            <option>Romance</option><option>Fic√ß√£o Cient√≠fica</option><option>Fantasia</option>
            <option>Terror</option><option>Mist√©rio</option><option>Thriller</option>
            <option>N√£o-fic√ß√£o</option><option>Biografia</option><option>Hist√≥ria</option>
            <option>Filosofia</option><option>Autoajuda</option><option>Cl√°ssico</option>
            <option>Literatura Brasileira</option><option>Infantil</option>
            <option>HQ / Graphic Novel</option><option>Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label>ano</label>
          <input type="number" id="f-year" placeholder="ex: 2001" min="1000" max="2100">
        </div>
      </div>
      <div class="form-group">
        <label>avalia√ß√£o</label>
        <select id="f-rating">
          <option value="0">sem avalia√ß√£o</option>
          <option value="1">‚≠ê</option><option value="2">‚≠ê‚≠ê</option>
          <option value="3">‚≠ê‚≠ê‚≠ê</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option>
          <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option>
        </select>
      </div>
      <div class="form-group">
        <label>observa√ß√µes</label>
        <textarea id="f-notes" rows="2" placeholder="estado do livro, edi√ß√£o especial..."></textarea>
      </div>
      <div class="form-group">
        <label>link amazon (opcional)</label>
        <input type="url" id="f-amazon" placeholder="https://amazon.com.br/...">
      </div>
      <div class="form-group">
        <label>marcadores</label>
        <div class="checkbox-group">
          <label class="checkbox-label"><input type="checkbox" id="f-donate"> üíö para doa√ß√£o</label>
          <label class="checkbox-label"><input type="checkbox" id="f-read"> ‚úÖ lido</label>
          <label class="checkbox-label"><input type="checkbox" id="f-wishlist"> üîµ wishlist</label>
          <label class="checkbox-label"><input type="checkbox" id="f-duplicate"> üî¥ repetido</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-save" id="btn-save-book" onclick="saveBook()">salvar livro</button>
      <button class="btn-cancel-sm" onclick="closeBookModal()">cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL: RESERVAR -->
<div class="modal-overlay" id="reserve-modal">
  <div class="modal" id="reserve-inner"></div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp }                         from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
  import { getFirestore, collection, doc,
           onSnapshot, addDoc, setDoc,
           deleteDoc }
         from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
  import { getStorage, ref, uploadString, getDownloadURL, deleteObject }
         from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js';

  // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  const firebaseConfig = {
    apiKey:            "AIzaSyDwC33fFGoeYJbq6xtoWiIHB3yYYa4hUF0",
    authDomain:        "livrhanna.firebaseapp.com",
    projectId:         "livrhanna",
    storageBucket:     "livrhanna.firebasestorage.app",
    messagingSenderId: "555806722861",
    appId:             "1:555806722861:web:f393ee4eb96e4910fb61a4"
  };
  // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

  // üîë mude a senha aqui
  const SENHA = 'V0lp4t45';

  const CONFIGURED = firebaseConfig.apiKey !== "COLE_AQUI";

  let db, storage;
  let books        = [];
  let reservations = {};
  let isAdmin      = false;
  let editingId    = null;
  let reservingId  = null;
  let pendingCover = null;
  let activeFilter    = 'all';
  let activeAuthor    = '';
  let activePublisher = '';
  let activeRating    = 0;
  let activeGenre     = '';

  const BG = ['#d4efec','#d6e5ef','#fce8e8','#e4d4ef','#d4e8d4','#f0e8d4','#e8d4d4'];
  const EM = {
    'Romance':'üíï','Fic√ß√£o Cient√≠fica':'üöÄ','Fantasia':'üßô','Terror':'üëª','Mist√©rio':'üïµÔ∏è',
    'Thriller':'üî™','N√£o-fic√ß√£o':'üìä','Biografia':'üë§','Hist√≥ria':'üèõÔ∏è','Filosofia':'ü§î',
    'Autoajuda':'üí™','Cl√°ssico':'üèÜ','Literatura Brasileira':'üåø','Infantil':'üåà','HQ / Graphic Novel':'ü¶∏'
  };

  const bgColor   = t => BG[Math.abs((t||'').split('').reduce((s,c)=>s+c.charCodeAt(0),0)) % BG.length];
  const bookEmoji = g => EM[g] || 'üìñ';
  const inits     = n => (n||'').trim().split(' ').filter(Boolean).slice(0,2).map(p=>p[0].toUpperCase()).join('');
  const esc       = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  const genId     = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2800);
  }

  function hideLoading() {
    const s = document.getElementById('loading-screen');
    s.classList.add('hidden');
    setTimeout(() => s.style.display = 'none', 500);
  }

  // ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
  if (!CONFIGURED) {
    document.getElementById('config-warning-area').innerHTML = `
      <div class="config-warning">
        <h3>‚ö†Ô∏è firebase ainda n√£o configurado</h3>
        <p>funcionando em modo local. cole as configura√ß√µes do firebase onde est√° <code>COLE_AQUI</code>.</p>
      </div>`;
    loadLocalFallback();
    hideLoading();
  } else {
    const app = initializeApp(firebaseConfig);
    db      = getFirestore(app);
    storage = getStorage(app);

    onSnapshot(collection(db, 'books'), snap => {
      books = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      books.sort((a,b) => (a.added||0) - (b.added||0));
      updateFilterDropdowns();
      render();
    });

    onSnapshot(collection(db, 'reservations'), snap => {
      reservations = {};
      snap.docs.forEach(d => { reservations[d.id] = d.data(); });
      render();
    });

    hideLoading();
  }

  // ‚îÄ‚îÄ LOCAL FALLBACK ‚îÄ‚îÄ
  function loadLocalFallback() {
    try { books        = JSON.parse(localStorage.getItem('livrhanna_books')   || '[]'); } catch(e) { books=[]; }
    try { reservations = JSON.parse(localStorage.getItem('livrhanna_reservas') || '{}'); } catch(e) { reservations={}; }
    if (!books.length) seedLocal();
    updateFilterDropdowns();
    render();
  }

  function seedLocal() {
    const s = [
      { title:'O Alquimista', author:'Paulo Coelho', publisher:'HarperCollins', genre:'Romance', year:'1988', rating:3, read:true, donate:true, duplicate:false, wishlist:false, notes:'' },
      { title:'Sapiens', author:'Yuval Noah Harari', publisher:'Companhia das Letras', genre:'N√£o-fic√ß√£o', year:'2011', rating:4, read:true, donate:true, duplicate:false, wishlist:false, notes:'' },
      { title:'Dom Casmurro', author:'Machado de Assis', publisher:'Martin Claret', genre:'Cl√°ssico', year:'1899', rating:5, read:true, donate:false, duplicate:false, wishlist:false, notes:'' },
    ];
    s.forEach(b => books.push({ id:genId(), added:Date.now(), coverUrl:null, ...b }));
    localStorage.setItem('livrhanna_books', JSON.stringify(books));
  }

  function saveLocal() {
    localStorage.setItem('livrhanna_books',   JSON.stringify(books));
    localStorage.setItem('livrhanna_reservas', JSON.stringify(reservations));
  }

  // ‚îÄ‚îÄ FILTER DROPDOWNS ‚îÄ‚îÄ
  function updateFilterDropdowns() {
    const authors    = [...new Set(books.map(b=>b.author).filter(Boolean))].sort();
    const publishers = [...new Set(books.map(b=>b.publisher).filter(Boolean))].sort();

    const aSelect = document.getElementById('filter-author');
    const pSelect = document.getElementById('filter-publisher');

    const aVal = aSelect.value;
    const pVal = pSelect.value;

    aSelect.innerHTML = '<option value="">por autor...</option>' +
      authors.map(a => `<option value="${esc(a)}"${a===aVal?' selected':''}>${esc(a)}</option>`).join('');

    pSelect.innerHTML = '<option value="">por editora...</option>' +
      publishers.map(p => `<option value="${esc(p)}"${p===pVal?' selected':''}>${esc(p)}</option>`).join('');

    // update active styling
    aSelect.classList.toggle('active', !!aSelect.value);
    pSelect.classList.toggle('active', !!pSelect.value);

    // genre dropdown
    const genres  = [...new Set(books.map(b=>b.genre).filter(Boolean))].sort();
    const gSelect = document.getElementById('filter-genre');
    const gVal    = gSelect.value;
    gSelect.innerHTML = '<option value="">por g√™nero...</option>' +
      genres.map(g => `<option value="${esc(g)}"${g===gVal?' selected':''}>${esc(g)}</option>`).join('');
    gSelect.classList.toggle('active', !!gSelect.value);

    // rating dropdown
    const ratings = [...new Set(books.map(b=>b.rating).filter(r=>r>0))].sort((a,b)=>b-a);
    const rSelect = document.getElementById('filter-rating');
    const rVal = parseInt(rSelect.value)||0;
    rSelect.innerHTML = '<option value="">por avalia√ß√£o...</option>' +
      ratings.map(r => `<option value="${r}"${r===rVal?' selected':''}>${'‚≠ê'.repeat(r)}</option>`).join('');
    rSelect.classList.toggle('active', !!rSelect.value);

    // update datalists for form
    const authDL = document.getElementById('authors-list');
    const pubDL  = document.getElementById('publishers-list');
    if (authDL) authDL.innerHTML = authors.map(a=>`<option value="${esc(a)}">`).join('');
    if (pubDL)  pubDL.innerHTML  = publishers.map(p=>`<option value="${esc(p)}">`).join('');
  }

  // ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
  window.handleQtyChange = () => {
    const qty = parseInt(document.getElementById('f-qty').value)||1;
    if (qty > 1) {
      document.getElementById('f-duplicate').checked = true;
      document.getElementById('f-donate').checked    = true;
    } else {
      document.getElementById('f-duplicate').checked = false;
    }
  };

  window.clickAdd = () => {
    // already admin ‚Äî nothing to do (button hidden anyway)
    if (isAdmin) return;
    document.getElementById('pass-input').value = '';
    document.getElementById('pass-error').textContent = '';
    document.getElementById('pass-modal').classList.add('show');
    setTimeout(() => document.getElementById('pass-input').focus(), 120);
  };

  window.closePassModal = () => document.getElementById('pass-modal').classList.remove('show');

  window.checkPass = () => {
    const val = document.getElementById('pass-input').value;
    if (val === SENHA) {
      isAdmin = true;
      window.closePassModal();
      document.getElementById('admin-bar').classList.add('on');
      document.body.classList.add('admin-unlocked');
      document.getElementById('btn-add-book').style.display = 'inline-block';
      document.getElementById('btn-restricted').style.display = 'none';
      document.querySelectorAll('.admin-only-filter').forEach(el => el.style.display = 'inline-block');
      render();
    } else {
      document.getElementById('pass-error').textContent = 'senha incorreta, tente novamente.';
      document.getElementById('pass-input').value = '';
      document.getElementById('pass-input').animate(
        [{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:240});
      document.getElementById('pass-input').focus();
    }
  };

  window.exitAdmin = () => {
    isAdmin = false;
    document.getElementById('admin-bar').classList.remove('on');
    document.body.classList.remove('admin-unlocked');
    document.getElementById('btn-add-book').style.display = 'none';
    document.getElementById('btn-restricted').style.display = 'inline-block';
    document.querySelectorAll('.admin-only-filter').forEach(el => el.style.display = 'none');
    render();
    showToast('saiu do modo admin.');
  };

  window.togglePassVis = () => {
    const i = document.getElementById('pass-input');
    i.type = i.type === 'password' ? 'text' : 'password';
  };

  // ‚îÄ‚îÄ BOOK MODAL ‚îÄ‚îÄ
  function openBookModal(id) {
    editingId    = id || null;
    pendingCover = null;
    const b = id ? books.find(b=>b.id===id) : null;

    document.getElementById('book-modal-title').textContent = b ? 'editar livro' : 'novo livro';
    document.getElementById('f-title').value       = b ? b.title         : '';
    document.getElementById('f-author').value      = b ? b.author        : '';
    document.getElementById('f-publisher').value   = b ? (b.publisher||''): '';
    document.getElementById('f-genre').value       = b ? (b.genre||'')    : '';
    document.getElementById('f-year').value        = b ? (b.year||'')     : '';
    document.getElementById('f-rating').value      = b ? (b.rating||0)    : 0;
    document.getElementById('f-qty').value         = b ? (b.qty||1)       : 1;
    document.getElementById('f-notes').value       = b ? (b.notes||'')    : '';
    document.getElementById('f-amazon').value      = b ? (b.amazonUrl||'')  : '';
    document.getElementById('f-donate').checked    = b ? !!b.donate       : true;
    document.getElementById('f-read').checked      = b ? !!b.read         : false;
    document.getElementById('f-wishlist').checked  = b ? !!b.wishlist     : false;
    document.getElementById('f-duplicate').checked = b ? !!b.duplicate    : false;

    const cc = document.getElementById('cover-content');
    if (b && b.coverUrl) {
      pendingCover = b.coverUrl;
      cc.innerHTML = `<img class="preview" src="${esc(b.coverUrl)}"><p style="font-size:.72rem;color:var(--teal);margin-top:4px;">‚úì foto atual ‚Äî clique para trocar</p>`;
    } else {
      cc.innerHTML = `<div class="upload-icon">üì∑</div><p>clique para adicionar uma foto</p>`;
    }

    document.getElementById('book-modal').classList.add('show');
    setTimeout(() => document.getElementById('f-title').focus(), 100);
  }

  window.closeBookModal = () => {
    document.getElementById('book-modal').classList.remove('show');
    editingId = pendingCover = null;
  };

  window.handleCover = e => {
    const file = e.target.files[0]; if (!file) return;
    const r = new FileReader();
    r.onload = ev => {
      pendingCover = ev.target.result;
      document.getElementById('cover-content').innerHTML =
        `<img class="preview" src="${pendingCover}"><p style="font-size:.72rem;color:var(--teal);margin-top:4px;">‚úì foto carregada ‚Äî clique para trocar</p>`;
    };
    r.readAsDataURL(file);
  };

  window.saveBook = async () => {
    const title     = document.getElementById('f-title').value.trim();
    const author    = document.getElementById('f-author').value.trim();
    const publisher = document.getElementById('f-publisher').value.trim();
    if (!title)  { showToast('preencha o t√≠tulo!');  return; }
    if (!author) { showToast('preencha o autor!'); return; }

    const btn = document.getElementById('btn-save-book');
    btn.disabled = true; btn.textContent = 'salvando...';

    const ex = editingId ? books.find(b=>b.id===editingId) : null;
    let coverUrl = ex ? (ex.coverUrl||null) : null;

    if (pendingCover && pendingCover !== coverUrl && CONFIGURED) {
      try {
        const imgId  = editingId || genId();
        const imgRef = ref(storage, `covers/${imgId}.jpg`);
        await uploadString(imgRef, pendingCover, 'data_url');
        coverUrl = await getDownloadURL(imgRef);
      } catch(err) { coverUrl = pendingCover; }
    } else if (pendingCover && pendingCover !== coverUrl) {
      coverUrl = pendingCover;
    }

    const bookData = {
      title, author, publisher,
      genre:     document.getElementById('f-genre').value,
      year:      document.getElementById('f-year').value,
      rating:    parseInt(document.getElementById('f-rating').value),
      qty:       parseInt(document.getElementById('f-qty').value)||1,
      notes:     document.getElementById('f-notes').value.trim(),
      amazonUrl: document.getElementById('f-amazon').value.trim(),
      donate:    (parseInt(document.getElementById('f-qty').value)||1) > 1 ? true : document.getElementById('f-donate').checked,
      read:      document.getElementById('f-read').checked,
      wishlist:  document.getElementById('f-wishlist').checked,
      duplicate: (parseInt(document.getElementById('f-qty').value)||1) > 1 ? true : document.getElementById('f-duplicate').checked,
      coverUrl,
      added: ex ? ex.added : Date.now()
    };

    try {
      if (CONFIGURED) {
        if (editingId) await setDoc(doc(db, 'books', editingId), bookData);
        else           await addDoc(collection(db, 'books'), bookData);
      } else {
        if (editingId) { const i = books.findIndex(b=>b.id===editingId); books[i] = { id:editingId, ...bookData }; }
        else books.push({ id:genId(), ...bookData });
        saveLocal(); updateFilterDropdowns(); render();
      }
      showToast(editingId ? 'livro atualizado! ‚úì' : 'livro adicionado! ‚úì');
      window.closeBookModal();
    } catch(err) {
      showToast('erro ao salvar. tente novamente.');
      console.error(err);
    }

    btn.disabled = false; btn.textContent = 'salvar livro';
  };

  window.deleteBook = async id => {
    const b = books.find(b=>b.id===id);
    if (!b || !confirm(`remover "${b.title}"?`)) return;
    if (CONFIGURED) {
      await deleteDoc(doc(db, 'books', id));
      await deleteDoc(doc(db, 'reservations', id)).catch(()=>{});
      if (b.coverUrl && b.coverUrl.includes('firebasestorage')) {
        try { await deleteObject(ref(storage, `covers/${id}.jpg`)); } catch(e){}
      }
    } else {
      books = books.filter(b=>b.id!==id);
      delete reservations[id];
      saveLocal(); updateFilterDropdowns(); render();
    }
    showToast('livro removido.');
  };

  // ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ
  window.setFilter = (type, el) => {
    if (type === 'author') {
      activeAuthor    = el.value;
      activePublisher = '';
      activeRating    = 0;
      activeGenre     = '';
      document.getElementById('filter-publisher').value = '';
      document.getElementById('filter-rating').value    = '';
      document.getElementById('filter-genre').value     = '';
      document.getElementById('filter-publisher').classList.remove('active');
      document.getElementById('filter-rating').classList.remove('active');
      document.getElementById('filter-genre').classList.remove('active');
      el.classList.toggle('active', !!el.value);
      // deactivate chips
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      activeFilter = 'all';
    } else if (type === 'publisher') {
      activePublisher = el.value;
      activeAuthor    = '';
      activeRating    = 0;
      activeGenre     = '';
      document.getElementById('filter-author').value    = '';
      document.getElementById('filter-rating').value    = '';
      document.getElementById('filter-genre').value     = '';
      document.getElementById('filter-author').classList.remove('active');
      document.getElementById('filter-rating').classList.remove('active');
      document.getElementById('filter-genre').classList.remove('active');
      el.classList.toggle('active', !!el.value);
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      activeFilter = 'all';
    } else if (type === 'genre') {
      activeGenre     = el.value;
      activeAuthor    = '';
      activePublisher = '';
      activeRating    = 0;
      document.getElementById('filter-author').value    = '';
      document.getElementById('filter-publisher').value = '';
      document.getElementById('filter-rating').value    = '';
      document.getElementById('filter-author').classList.remove('active');
      document.getElementById('filter-publisher').classList.remove('active');
      document.getElementById('filter-rating').classList.remove('active');
      el.classList.toggle('active', !!el.value);
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    } else if (type === 'rating') {
      activeRating    = parseInt(el.value)||0;
      activeFilter    = 'rating';
      activeAuthor    = '';
      activePublisher = '';
      activeGenre     = '';
      document.getElementById('filter-author').value    = '';
      document.getElementById('filter-publisher').value = '';
      document.getElementById('filter-genre').value     = '';
      document.getElementById('filter-author').classList.remove('active');
      document.getElementById('filter-publisher').classList.remove('active');
      document.getElementById('filter-genre').classList.remove('active');
      el.classList.toggle('active', !!el.value);
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    } else {
      activeFilter    = type;
      activeAuthor    = '';
      activePublisher = '';
      activeRating    = 0;
      activeGenre     = '';
      document.getElementById('filter-author').value    = '';
      document.getElementById('filter-publisher').value = '';
      document.getElementById('filter-rating').value    = '';
      document.getElementById('filter-genre').value     = '';
      document.getElementById('filter-author').classList.remove('active');
      document.getElementById('filter-publisher').classList.remove('active');
      document.getElementById('filter-rating').classList.remove('active');
      document.getElementById('filter-genre').classList.remove('active');
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      if (el.classList) el.classList.add('active');
    }
    render();
  };

  // ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
  function render() {
    const q = (document.getElementById('search').value||'').toLowerCase();

    const list = books.filter(b => {
      const ms = !q || b.title.toLowerCase().includes(q)
                    || (b.author||'').toLowerCase().includes(q)
                    || (b.publisher||'').toLowerCase().includes(q);
      let mf = true;
      if (activeAuthor)         mf = b.author    === activeAuthor;
      else if (activePublisher) mf = b.publisher === activePublisher;
      else if (activeGenre)     mf = b.genre     === activeGenre;
      else {
        if (activeFilter==='donate')  mf = b.donate;
        if (activeFilter==='read')    mf = b.read;
        if (activeFilter==='wishlist')mf = b.wishlist;
        if (activeFilter==='rating' && activeRating)  mf = b.rating === activeRating;
      }
      return ms && mf;
    });

    // sort
    const sortVal = document.getElementById('sort-select').value;
    if (sortVal === 'alpha-asc')   list.sort((a,b) => a.title.localeCompare(b.title, 'pt'));
    if (sortVal === 'alpha-desc')  list.sort((a,b) => b.title.localeCompare(a.title, 'pt'));
    if (sortVal === 'added-asc')   list.sort((a,b) => (a.added||0) - (b.added||0));
    if (sortVal === 'added-desc')  list.sort((a,b) => (b.added||0) - (a.added||0));

    document.getElementById('stat-total').textContent    = books.length;
    document.getElementById('stat-donate').textContent   = books.filter(b=>b.donate).length;
    document.getElementById('stat-reserved').textContent = books.filter(b=>reservations[b.id]).length;

    let labelText = `${list.length} livro${list.length!==1?'s':''}`;
    if (q) labelText = `resultados para "${q}"`;
    else if (activeAuthor)    labelText = `livros de ${activeAuthor}`;
    else if (activePublisher) labelText = `editora ${activePublisher}`;
    else if (activeFilter==='donate')  labelText = `${list.length} livro${list.length!==1?'s':''} para doa√ß√£o`;
    else if (activeFilter==='read')    labelText = `${list.length} livro${list.length!==1?'s':''} lidos`;
    else if (activeFilter==='wishlist')labelText = `${list.length} na wishlist`;
    else if (activeFilter==='rating' && activeRating) labelText = `${list.length} livro${list.length!==1?'s':''} com ${'‚≠ê'.repeat(activeRating)}`;
    else if (activeGenre) labelText = `g√™nero: ${activeGenre} (${list.length} livro${list.length!==1?'s':''})`;    

    document.getElementById('section-label').textContent = labelText;

    const grid  = document.getElementById('books-grid');
    const empty = document.getElementById('empty-state');

    if (!list.length) { grid.innerHTML=''; empty.style.display='block'; return; }
    empty.style.display='none';

    grid.innerHTML = list.map((b, i) => {
      const res   = reservations[b.id];
      const bg    = bgColor(b.title);
      const stars = b.rating ? '‚≠ê'.repeat(b.rating) : '';

      const coverInner = b.coverUrl
        ? `<img src="${esc(b.coverUrl)}" alt="${esc(b.title)}">`
        : `<span class="cover-emoji">${bookEmoji(b.genre)}</span>`;

      const reservedOver = res ? `<div class="reserved-overlay"><div class="reserved-stamp">reservado</div></div>` : '';
      const donateBadge  = b.donate ? `<span class="donate-badge">üíö doa√ß√£o</span>` : '';

      const reservedBy = res ? `
        <div class="reserved-by">
          <div class="avatar">${inits(res.name)}</div>
          <div><span class="res-label">reservado por</span><span class="res-name"> ${esc(res.name)}</span></div>
        </div>` : '';

      const adminBtns = `
        <div class="card-admin">
          <button class="card-btn edit" onclick="window._editBook('${b.id}')" title="editar">‚úèÔ∏è</button>
          <button class="card-btn del"  onclick="window.deleteBook('${b.id}')" title="remover">üóëÔ∏è</button>
        </div>`;

      // "cancelar reserva" button: CSS hides it unless admin-unlocked
      let footer = '';
      if (b.donate) {
        footer = !res
          ? `<div class="book-footer"><button class="btn-quero" onclick="window._openReserve('${b.id}')">üíö eu quero!</button></div>`
          : `<div class="book-footer">
               <button class="btn-cancelar" onclick="window._cancelReserve('${b.id}')">cancelar reserva</button>
             </div>`;
      }

      const notes = b.notes ? `<div class="book-notes">${esc(b.notes)}</div>` : '';
      const amazonBtn = b.amazonUrl ? `
        <div style="padding: 0 11px 10px;">
          <a class="btn-amazon" href="${esc(b.amazonUrl)}" target="_blank" rel="noopener">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="#111"><path d="M13.23 10.56C13.23 11.16 13.25 11.65 13.18 12.13 12.95 13.5 11.93 14.34 10.56 14.34 9.65 14.34 9.01 13.73 9.01 12.81 9.01 11.13 10.5 10.79 13.23 10.79V10.56ZM16.67 17.27C16.44 17.47 16.1 17.49 15.85 17.36 14.73 16.41 14.54 15.97 13.92 15.08 12.08 16.96 10.77 17.53 8.42 17.53 5.63 17.53 3.47 15.82 3.47 12.36 3.47 9.67 4.94 7.84 7.08 7.01 8.93 6.27 11.5 6.14 13.23 5.93V5.53C13.23 4.82 13.28 3.98 12.86 3.37 12.5 2.82 11.8 2.6 11.18 2.6 9.99 2.6 8.94 3.22 8.67 4.48 8.62 4.75 8.42 5.02 8.15 5.03L5.03 4.7C4.79 4.64 4.52 4.45 4.59 4.09 5.3.48 8.56-.5 11.5-.5 13 -.5 14.97-.08 16.11 1.01 17.56 2.36 17.43 4.14 17.43 6.06V10.79C17.43 12.13 17.98 12.73 18.5 13.46 18.68 13.72 18.72 14.03 18.49 14.22L16.67 15.78 16.67 17.27Z"/></svg>
            ver na amazon
          </a>
        </div>` : '';

      return `
        <div class="book-card${res?' is-reserved':''}" style="animation-delay:${Math.min(i*.04,.3)}s">
          ${adminBtns}
          <div class="book-cover" style="background:${bg}">
            ${coverInner}
            ${reservedOver}
            ${donateBadge}
          </div>
          <div class="book-body">
            <div class="pub-title">${esc(b.title)}</div>
            <div class="pub-author clickable-tag" onclick="window._filterBy('author','${esc(b.author)}')" title="ver todos de ${esc(b.author)}">${esc(b.author)}</div>
            <div class="book-meta">
              ${b.genre    ? `<span class="meta-tag clickable-tag" onclick="window._filterBy('genre','${esc(b.genre)}')" title="filtrar por ${esc(b.genre)}">${esc(b.genre)}</span>` : ''}
              ${b.year     ? `<span class="meta-tag">${b.year}</span>` : ''}
              ${b.publisher ? `<span class="meta-tag clickable-tag" onclick="window._filterBy('publisher','${esc(b.publisher)}')" title="filtrar por ${esc(b.publisher)}">${esc(b.publisher)}</span>` : ''}
              ${isAdmin && b.read      ? '<span class="meta-tag" style="background:var(--teal-pale);color:var(--teal-dark);">‚úì lido</span>'     : ''}
              ${b.duplicate ? '<span class="meta-tag" style="background:var(--pink-pale);color:var(--pink-dark);">repetido</span>'   : ''}
              ${isAdmin && b.wishlist  ? '<span class="meta-tag" style="background:var(--blue-pale);color:var(--blue-dark);">wishlist</span>'   : ''}
            </div>
            ${stars ? `<div class="book-rating">${stars}</div>` : ''}
            ${reservedBy}
          </div>
          ${notes}
          ${amazonBtn}
          ${footer}
        </div>`;
    }).join('');
  }

  window._filterBy = (type, value) => {
    if (!value) return;
    // update the correct select
    const selId = type === 'author' ? 'filter-author' : type === 'publisher' ? 'filter-publisher' : 'filter-genre';
    const sel = document.getElementById(selId);
    // ensure option exists then set it
    if (![...sel.options].some(o => o.value === value)) {
      sel.innerHTML += `<option value="${value}">${value}</option>`;
    }
    sel.value = value;
    window.setFilter(type, sel);
    // scroll to top of grid smoothly
    document.getElementById('books-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  window.openBookModal = id => { if (isAdmin) openBookModal(id); };
  window._editBook = id => { if (isAdmin) openBookModal(id); };

  // ‚îÄ‚îÄ RESERVE ‚îÄ‚îÄ
  window._openReserve = bookId => {
    reservingId = bookId;
    const b  = books.find(b=>b.id===bookId);
    const bg = bgColor(b.title);
    const iconHTML = b.coverUrl
      ? `<img src="${esc(b.coverUrl)}" style="width:52px;height:52px;object-fit:cover;border-radius:6px;">`
      : `<div style="font-size:1.8rem;background:${bg};width:52px;height:52px;border-radius:6px;display:flex;align-items:center;justify-content:center;">${bookEmoji(b.genre)}</div>`;

    document.getElementById('reserve-inner').innerHTML = `
      <div class="modal-header">
        <div><h2>reservar livro</h2><p>seu nome ficar√° vis√≠vel para todos</p></div>
        <button class="modal-close" onclick="window._closeReserve()">‚úï</button>
      </div>
      <div class="modal-book-preview">
        <div class="modal-book-icon">${iconHTML}</div>
        <div>
          <div class="modal-book-title">${esc(b.title)}</div>
          <div class="modal-book-author">${esc(b.author)}</div>
        </div>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group"><label>nome *</label><input type="text" id="r-nome" placeholder="Maria" autocomplete="given-name"></div>
          <div class="form-group"><label>sobrenome *</label><input type="text" id="r-sobre" placeholder="Silva" autocomplete="family-name"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-save" id="btn-confirm-res" onclick="window._confirmReserve()">üíö confirmar reserva</button>
        <button class="btn-cancel-sm" onclick="window._closeReserve()">cancelar</button>
        <p class="privacy-note">üëÅÔ∏è seu nome ser√° exibido publicamente nesta p√°gina</p>
      </div>
    `;
    document.getElementById('reserve-modal').classList.add('show');
    setTimeout(() => document.getElementById('r-nome').focus(), 120);
  };

  window._closeReserve = () => {
    document.getElementById('reserve-modal').classList.remove('show');
    reservingId = null;
  };

  window._confirmReserve = async () => {
    const nome  = document.getElementById('r-nome').value.trim();
    const sobre = document.getElementById('r-sobre').value.trim();
    if (!nome)  { shake('r-nome');  return; }
    if (!sobre) { shake('r-sobre'); return; }

    const btn = document.getElementById('btn-confirm-res');
    btn.disabled = true; btn.textContent = 'salvando...';

    const full    = nome + ' ' + sobre;
    const b       = books.find(b=>b.id===reservingId);
    const resData = { name: full, at: new Date().toLocaleDateString('pt-BR'), bookTitle: b.title };

    try {
      if (CONFIGURED) await setDoc(doc(db, 'reservations', reservingId), resData);
      else { reservations[reservingId] = resData; saveLocal(); render(); }

      document.getElementById('reserve-inner').innerHTML = `
        <div class="success-body">
          <div class="success-icon">üíö</div>
          <h3>reservado!</h3>
          <p><strong>${esc(b.title)}</strong> est√° reservado para <strong style="text-transform:none">${esc(full)}</strong>.<br><br>entre em contato para combinar a retirada!</p>
          <button class="btn-fechar" onclick="window._closeReserve()">fechar</button>
        </div>
      `;
    } catch(err) {
      showToast('erro ao reservar. tente novamente.');
      btn.disabled = false; btn.textContent = 'üíö confirmar reserva';
    }
  };

  window._cancelReserve = async id => {
    const r = reservations[id];
    if (!r || !confirm(`cancelar a reserva de ${r.name}?`)) return;
    if (CONFIGURED) await deleteDoc(doc(db, 'reservations', id));
    else { delete reservations[id]; saveLocal(); render(); }
    showToast('reserva cancelada.');
  };

  function shake(id) {
    const el = document.getElementById(id);
    el.style.borderColor = 'var(--pink)';
    el.animate([{transform:'translateX(-5px)'},{transform:'translateX(5px)'},{transform:'translateX(0)'}],{duration:220});
    el.focus();
    setTimeout(() => el.style.borderColor='', 1200);
  }

  // ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ
  ['pass-modal','book-modal','reserve-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
      if (e.target.id === id) {
        if (id==='pass-modal')    window.closePassModal();
        if (id==='book-modal')    window.closeBookModal();
        if (id==='reserve-modal') window._closeReserve();
      }
    });
  });

  document.addEventListener('keydown', e => {
    if (e.key==='Escape') { window.closePassModal(); window.closeBookModal(); window._closeReserve(); }
  });

  document.getElementById('search').addEventListener('input', render);
  window.render = render;
</script>
</body>
</html>
